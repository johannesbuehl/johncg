<!DOCTYPE html>
<meta charset="UTF-8">
<html>
	<script>
		const Config = {
			
		};
	</script>
	<head>
		<title>
			JohnCG - Song-template
		</title>
		<style>
			* {
				cursor: pointer;

				user-select: none;
			}

			body {
				font-size: calc(1500vw / 1920);

				margin: 0;

				overflow: hidden;

				background-color: transparent;
			}

			#_main {
				opacity: 0;

				transition: opacity 0.5s linear;

				width: 100vw;
				height: 100vh;

				display: flex;
				justify-content: center;
				align-items: center;
			}

			#container {
				color: white;

				width: 100%;
				height: 100%;
				
				background-repeat: no-repeat;
				background-position: center;
				background-size: cover;
			}

			#container > * {
				height: 100%;

				display: flex;
				align-items: center;
				justify-content: center;
			}

			#storage {
				color: white;
				opacity: 0;

				width: fit-content;
			}

			/* Hide the title so it doesn't get width calculated */
			#storage > * > .title {
				display: none;
			}
			
			.slide {
				width: auto;
				height: auto;

				margin: 1em;
			}

			.slide.title {
				display: flex;
				flex-direction: column;
				justify-content: center;

				height: 100%;
				width: 100%;

				font-size: 8em;
			}

			.slide > * {
				text-shadow: calc(1em / 16) calc(1em / 16) calc(1em / 8) black;
			}

			.slide.lyric {
				display: flex;
				flex-direction: column;

				justify-content: center;
			}

			.slide.title > .title_container {
				display: flex;
				justify-content: flex-end;
				flex-direction: column;
			}
			
			.slide.title > .title_container > div {
				font-family: "Bahnschrift Condensed";
			}

			.slide.title > .title_container > .language_0 {

			}

			.slide.title > .title_container > .language_1 {
				color: hsl(0 0% 62.5%);
				font-size: 0.625em;

				font-style: italic;
			}

			.slide.title > .title_container > .language_2 {
				color: hsl(0 0% 62.5%);
				font-size: 0.625em;

				font-style: italic;
			}

			.slide.title > .title_container > .language_3 {
				color: hsl(0 0% 62.5%);
				font-size: 0.625em;

				font-style: italic;
			}

			.slide > .song_id {
				font-family: "Bahnschrift Condensed";
				font-weight: 100;

				font-size: 0.75em;
			}
			
			.text_line {
				font-family: "Bahnschrift";
				
				text-align: center;
				
				white-space: nowrap;
			}
			
			.text_line.language_0 {
				font-size: 1em;
			}

			.text_line.language_1 {
				color: hsl(0 0% 62.5%);
				font-size: 0.625em;

				font-style: italic;
			}

			.text_line.language_2 {
				color: hsl(0 0% 62.5%);
				font-size: 0.625em;

				font-style: italic;
			}

			.text_line.language_3 {
				color: hsl(0 0% 62.5%);
				font-size: 0.625em;

				font-style: italic;
			}
		</style>
	</head>
	<body>
		<div id="_main">
			<div id="container">

			</div>
		</div>
		<div id="storage"></div>
	</body>
	<script>
		let data = {};

		let active_slide = 0;
		let slide_count = 0;
		
		// casparcg-function: transmits data
		function update(s_data) {
			// parse the transferred data into json
			data = JSON.parse(s_data);
		
			// get the div for the display and storage
			const div_container = document.querySelector("#container");
			const div_storage = document.querySelector("#storage");

			// clear the storage-container
			div_storage.innerHTML = "";
		
			// counter for the individual slides
			let slide_counter = 0;
		
			// create the slides and store them in the container
			for (const slide_data of data["slides"]) {
				// parent-div of slide
				const div_slide = create_slide(slide_data, data.languages);
				div_slide.dataset.slide = slide_counter;
				div_storage.append(div_slide);
		
				slide_counter++;
			}
		
			// store the amount of slides
			slide_count = slide_counter;
		
			div_container.style.backgroundImage = `url("${data.backgroundImage.replace(/\\/g, "\\\\")}")`;
		
			active_slide = data.slide;
		
			// display the first slide
			jump(active_slide);
			
			// resize all the slides (has to be done after displayin the first slide)
			resize_slides();
		}
		
		// casparcg-function: displays the template
		function play() {
			document.querySelector("#_main").style.opacity = 1;
		}
		
		// casparcg-function: advances to the next step
		function next() {
			jump(active_slide + 1);
		}
		
		// custom-function (through invoke): advance to the previous step
		function prev() {
			jump(active_slide - 1);
		}
		
		// custom-function (through invoke): jump to an arbitrary slide
		function jump(i_counter_raw) {
			const counter = clamp_slide_counter(i_counter_raw)
		
			// get the container to display the load the slide into
			const div__main = document.querySelector("#container");
		
			// clear the content of the container
			div__main.innerHTML = "";
		
			// clone the slide and change its id, so the id stays unique
			const div_slide = document.querySelector(`[data-slide='${counter}']`).cloneNode(true);
			div_slide.id = "slide_active";
		
			div__main.appendChild(div_slide);
		
			active_slide = counter;
		}
		
		// casparcg-function: hide the template
		function stop() {
			document.querySelector("#_main").style.opacity = 0;
		}
		
		// clamp the counter to valid values
		function clamp_slide_counter(counter_raw) {
			return Math.max(0, Math.min(slide_count - 1, counter_raw));
		}
		
		// change the font-size so the slide with the highest width uses all of the available space
		function resize_slides() {
			// get the highest width
			const max_width = get_max_width();
		
			// get the width of the container
			const current_container_width = document.querySelector("#slide_active").clientWidth;
		
			resize_slides_text(max_width, current_container_width);
		}
		
		// get the width of the widest slide
		function get_max_width() {
			let max_width = 0;
		
			// get the width of the individual slides and store the biggest one 
			for (let ii = 0; ii < slide_count; ii++) {
				const slide = document.querySelector(`#storage [data-slide='${ii}']`);
		
				if (slide.querySelector(".lyric") !== undefined) {
					let current_width = slide.clientWidth;
					max_width = Math.max(current_width, max_width);
				}
			}
		
			return max_width;
		}
		
		function create_slide(slide_data, languages) {
			// parent-div of slide
			const div_slide = document.createElement("div");

			const div_content = document.createElement("div");
			div_content.classList.add("slide");
			div_slide.append(div_content);

			switch (slide_data.type) {
				case "title": {
					div_content.classList.add("title");
					const title_container = document.createElement("div");
					title_container.classList.add("title_container")
					div_content.append(title_container);

					// create the titles for the individual languages
					languages.forEach((language, index) => {
						const div_title = document.createElement("div");
						div_title.classList.add(`language_${index}`);
						div_title.innerText = slide_data.title[language];
						title_container.append(div_title);
					})

					const div_churchSongID = document.createElement("div");
					div_churchSongID.classList.add("song_id");

					if (slide_data.ChurchSongID !== undefined) {
						div_churchSongID.innerText = slide_data.ChurchSongID;
					}

					div_content.append(div_churchSongID);
				} break;
				case "lyric": {
					div_content.classList.add("lyric");

					// add the individual text-lines
					for (const line_package of slide_data.data) {
						// create a template for the line
						const line_template = document.createElement("div");
						line_template.classList.add("text_line");

						// add the individual languages
						languages.forEach((language, index) => {
							const line = line_template.cloneNode(true);
							line.classList.add(`language_${index}`);
							line.innerText = line_package[language];
	
							div_content.append(line);
						});
					}
				} break;
			}
					
			return div_slide;
		}

		function resize_slides_text(max_width, container_width) {
			// change the font size by the size difference ratio
			document.querySelectorAll(".slide.lyric").forEach((ele) => {
				ele.style.fontSize = `${container_width / max_width}em`;
			});
		}
	</script>
</html>