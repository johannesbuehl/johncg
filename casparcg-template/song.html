<!DOCTYPE html>
<meta charset="UTF-8">
<html>
	<script>
		const Config = {
			
		};
	</script>
	<head>
		<title>
			johnCG - template
		</title>
		<style>
			body {
				margin: 0;

				overflow: hidden;

				background-color: black;
			}

			#_main {
				opacity: 0;

				width: 100vw;
				height: 100vh;

				display: flex;
				justify-content: center;
				align-items: center;
			}

			#container {
				color: white;

				width: 100%;
				height: 100%;
				
				background-repeat: no-repeat;
				background-position: center;
				background-size: cover;
			}

			#container > * {
				height: 100%;

				display: flex;
				align-items: center;
				justify-content: center;
			}

			.slide {
				width: auto;
				height: auto;

				margin: 100px;
			}
			
			.slide.title {
				display: grid;

				grid-template-rows: 1fr 1fr;

				height: 100%;
				width: 100%;

				font-size: 8em;
			}

			.slide > * {
				text-shadow: calc(1em / 16) calc(1em / 16) calc(1em / 8) black;
			}

			.slide.lyric {
				display: flex;
				flex-direction: column;

				justify-content: center;
			}

			.slide > .title {
				font-family: "Bahnschrift Condensed";

				display: flex;
				align-items: flex-end;
			}

			.slide > .song_id {
				font-family: "Bahnschrift Condensed";
				font-weight: 100;

				font-size: 0.75em;

				white-space: nowrap;
			}

			.text_line {
				font-family: "Bahnschrift";

				font-size: 2em;

				text-align: center;
			}

			#storage {
				color: white;
				opacity: 0;

				width: fit-content;
			}

			/* Hide the title so it doesn't get width calculated */
			#storage > * > .title {
				display: none;
			}
		</style>
	</head>
	<body>
		<div id="_main">
			<div id="container">

			</div>
		</div>
		<div id="storage"></div>
	</body>
	<script>
		let data = {};

		let active_slide = 0;
		let slide_count = 0;

		// casparcg-function: transmits data
		function update(s_data) {
			// parse the transferred data into json
			data = JSON.parse(s_data);

			// get the div for the display and storage
			const div_container = document.querySelector("#container");
			const div_storage = document.querySelector("#storage");

			// clear the storage-container
			div_storage.innerHTML = "";

			// counter for the individual slides
			let slide_counter = 0;

			// create the slides and store them in the container
			for (const slide of data["slides"]) {
				// parent-div of slide
				const div_slide = document.createElement("div");
				div_slide.dataset.slide = slide_counter;

				const div_content = document.createElement("div");
				div_content.classList.add("slide");
				div_slide.append(div_content);

				switch (slide.type) {
					case "title":
							div_content.classList.add("title");

							const div_title = document.createElement("div");
							div_title.classList.add("title");
							div_title.innerText = slide.title;
							div_content.append(div_title);

							const div_churchSongID = document.createElement("div");
							div_churchSongID.classList.add("song_id");

							if (slide.ChurchSongID !== undefined) {
								div_churchSongID.innerText = slide.ChurchSongID;
							}

							div_content.append(div_churchSongID);

						break;
					case "lyric":
						div_content.classList.add("lyric");

						// add the individual text-lines
						for (const s_line of slide.data) {
							const div_line = document.createElement("div");
							div_line.classList.add("text_line");
							div_line.innerText = s_line;
							
							div_content.append(div_line);
						}
						break;
					}
						
				div_storage.append(div_slide);
				slide_counter++;
			}

			// store the amount of slides
			slide_count = slide_counter;

			div_container.style.backgroundImage = `url("${data.backgroundImage.replace(/\\/g, "\\\\")}")`;

			active_slide = data.slide;

			// display the first slide
			jump(active_slide);
			// resize all the slides (has to be done after displayin the first slide)
			resize_slides();
		}

		// casparcg-function: displays the template
		function play() {
			document.querySelector("#_main").style.opacity = 1;
		}

		// casparcg-function: advances to the next step
		function next() {
			jump(active_slide + 1);
		}

		// custom-function (through invoke): advance to the previous step
		function prev() {
			jump(active_slide - 1);
		}

		// custom-function (through invoke): jump to an arbitrary slide
		function jump(i_counter_raw) {
			const i_counter = i_clamp_slide_counter(i_counter_raw)

			// get the container to display the load the slide into
			const c_div__main = document.querySelector("#container");

			// clear the content of the container
			c_div__main.innerHTML = "";

			// clone the slide and change its id, so the id stays unique
			const c_div_slide = document.querySelector(`[data-slide='${i_counter}']`).cloneNode(true);
			c_div_slide.id = "slide_active";

			c_div__main.appendChild(c_div_slide);

			active_slide = i_counter;
		}

		// casparcg-function: hide the template
		function stop() {
			document.querySelector("#_main").style.opacity = 0;
		}

		// clamp the counter to valid values
		function i_clamp_slide_counter(i_counter_raw) {
			return Math.max(0, Math.min(slide_count - 1, i_counter_raw));
		}

		// change the font-size so the slide with the highest width uses all of the available space
		function resize_slides() {
			// get the highest width
			const c_i_max_width = i_get_max_width();

			// get the width of the container
			const c_i_current_container_width = document.querySelector("#slide_active").clientWidth;

			// change the font size by the size difference ratio
			document.querySelectorAll(".slide.lyric").forEach((ele) => {
				ele.style.fontSize = `${c_i_current_container_width / c_i_max_width}em`;
			});
		}

		// get the width of the widest slide
		function i_get_max_width() {
			let i_max_width = 0;

			// get the width of the individual slides and store the biggest one 
			for (let ii = 0; ii < slide_count; ii++) {
				const slide = document.querySelector(`#storage [data-slide='${ii}']`);

				if (slide.querySelector(".lyric") !== undefined) {
					let i_current_width = slide.clientWidth;
					i_max_width = Math.max(i_current_width, i_max_width);
				}
			}

			return i_max_width;
		}
	</script>
</html>